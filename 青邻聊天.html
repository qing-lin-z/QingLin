
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青邻聊天 - AI聊天工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E40AF',
                        accent: '#60A5FA',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass-effect {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            .chat-bubble {
                position: relative;
                max-width: 80%;
            }
            .chat-bubble:before {
                content: '';
                position: absolute;
                top: 12px;
                width: 0;
                height: 0;
                border-style: solid;
            }
            .user-bubble:before {
                right: -10px;
                border-width: 5px 0 5px 10px;
                border-color: transparent transparent transparent #3B82F6;
            }
            .ai-bubble:before {
                left: -10px;
                border-width: 5px 10px 5px 0;
                border-color: transparent #E2E8F0 transparent transparent;
            }
            .muted-ai {
                opacity: 0.6;
            }
            .muted-ai .chat-bubble {
                background-color: #F3F4F6 !important;
                color: #9CA3AF !important;
            }
            .typing-indicator {
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }
            .typing-indicator span {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: #94A3B8;
                animation: typing 1.4s infinite both;
            }
            .typing-indicator span:nth-child(2) {
                animation-delay: 0.2s;
            }
            .typing-indicator span:nth-child(3) {
                animation-delay: 0.4s;
            }
            @keyframes typing {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
            }
            .slide-in {
                animation: slideIn 0.3s ease-out;
            }
            @keyframes slideIn {
                from { transform: translateX(-100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            }
            .hover-scale {
                transition: transform 0.2s ease-in-out;
            }
            .hover-scale:hover {
                transform: scale(1.05);
            }
            .group-chat-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            .truncate-text {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .author-text {
                color: #3B82F6;
                cursor: pointer;
                text-decoration: underline;
                transition: all 0.2s ease;
            }
            .author-text:hover {
                color: #1E40AF;
                transform: scale(1.05);
            }
            .donation-qrcode {
                transition: transform 0.3s ease;
            }
            .donation-qrcode:hover {
                transform: scale(1.1);
            }
            .recording-pulse {
                animation: recordingPulse 1.5s infinite;
            }
            @keyframes recordingPulse {
                0% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.1); opacity: 0.8; }
                100% { transform: scale(1); opacity: 1; }
            }
            .voice-wave {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 2px;
            }
            .voice-bar {
                width: 2px;
                background-color: #3B82F6;
                animation: voiceWave 1.2s infinite ease-in-out;
            }
            .voice-bar:nth-child(1) { height: 8px; animation-delay: 0s; }
            .voice-bar:nth-child(2) { height: 12px; animation-delay: 0.1s; }
            .voice-bar:nth-child(3) { height: 16px; animation-delay: 0.2s; }
            .voice-bar:nth-child(4) { height: 12px; animation-delay: 0.3s; }
            .voice-bar:nth-child(5) { height: 8px; animation-delay: 0.4s; }
            @keyframes voiceWave {
                0%, 100% { transform: scaleY(1); }
                50% { transform: scaleY(0.3); }
            }
            .recording-hint {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(239, 68, 68, 0.9);
                color: white;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 500;
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .recording-hint.show {
                opacity: 1;
            }
            .modal-container {
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 50;
                padding: 16px;
                overflow-y: auto;
                visibility: hidden;
                opacity: 0;
                transition: visibility 0s linear 0.3s, opacity 0.3s;
            }
            .modal-container.show {
                visibility: visible;
                opacity: 1;
                transition-delay: 0s;
            }
            .modal-content {
                background-color: white;
                border-radius: 16px;
                max-width: 600px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                transform: translateY(20px);
                transition: transform 0.3s ease;
                position: relative;
                padding-top: 60px;
            }
            .modal-container.show .modal-content {
                transform: translateY(0);
            }
            .modal-close-btn {
                position: absolute;
                top: 20px;
                right: 20px;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-color: #ef4444;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
                z-index: 10;
                font-size: 18px;
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            }
            .modal-close-btn:hover {
                background-color: #dc2626;
                transform: scale(1.1);
                box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen">
    <!-- 登录界面 -->
    <div id="loginScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 text-white">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 pulse-animation">
                    <i class="fa fa-comments text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2">青邻聊天</h1>
                <p class="text-white/80">智能AI聊天工具</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">硅基流动API密钥</label>
                    <input type="password" id="apiKeyInput" 
                           class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent"
                           placeholder="sk-xxxxxxxxxxxxxxxxxxxx" required>
                    <p class="text-xs text-white/60 mt-1">您的API密钥将安全存储在浏览器本地</p>
                </div>
                
                <button type="submit" 
                        class="w-full bg-white text-primary font-semibold py-3 px-4 rounded-lg hover:bg-gray-100 transition-colors duration-300 transform hover:scale-105">
                    <i class="fa fa-sign-in mr-2"></i>
                    登录
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-white/60">
                    没有API密钥？<a href="https://cloud.siliconflow.cn/" target="_blank" class="text-white hover:underline">前往硅基流动获取</a>
                </p>
            </div>
        </div>
    </div>

    <!-- 桌面端主界面 -->
    <div id="mainScreen" class="hidden flex h-screen">
        <!-- 侧边栏 -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <!-- 侧边栏头部 -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800">青邻聊天</h2>
                    <div class="flex gap-2">
                        <button id="newGroupBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fa fa-plus-square"></i>
                        </button>
                        <button id="settingsBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fa fa-bullseye"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 添加AI按钮 -->
                <button id="addAiBtn" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-secondary transition-colors duration-300 flex items-center justify-center gap-2 hover-scale">
                    <i class="fa fa-plus"></i>
                    添加AI
                </button>
            </div>

            <!-- 聊天列表 -->
            <div class="flex-1 overflow-y-auto p-4">
                <!-- 群聊列表 -->
                <div class="space-y-2 mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">群聊房间</h3>
                        <button id="manageGroupsBtn" class="text-xs text-primary hover:underline">管理</button>
                    </div>
                    
                    <div id="groupList" class="space-y-1">
                        <!-- 群聊项目将通过JavaScript动态添加 -->
                    </div>
                </div>

                <!-- AI列表 -->
                <div class="space-y-2">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">我的AI</h3>
                    <div id="aiList" class="space-y-1">
                        <!-- AI项目将通过JavaScript动态添加 -->
                    </div>
                </div>
            </div>

            <!-- 侧边栏底部 -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center justify-between text-sm text-gray-600">
                    <span id="apiKeyDisplay">API: sk-...</span>
                    <button id="logoutBtn" class="text-red-500 hover:text-red-700 transition-colors">
                        退出
                    </button>
                </div>
            </div>
        </div>

        <!-- 聊天区域 -->
        <div class="flex-1 flex flex-col bg-gray-50">
            <!-- 聊天头部 -->
            <div class="bg-white border-b border-gray-200 p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="currentChatAvatar" class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fa fa-users text-white"></i>
                    </div>
                    <div>
                        <h2 id="currentChatTitle" class="text-xl font-bold text-gray-800">群聊</h2>
                        <p id="currentChatSubtitle" class="text-sm text-gray-500">与所有AI聊天</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- 群聊管理按钮 -->
                    <button id="groupSettingsBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-gray-100 rounded-lg transition-colors hidden">
                        <i class="fa fa-cog"></i>
                    </button>
                    <button id="clearChatBtn" class="p-2 text-gray-500 hover:text-red-500 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fa fa-trash"></i>
                    </button>
                    <button id="exportChatBtn" class="p-2 text-gray-500 hover:text-primary hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fa fa-download"></i>
                    </button>
                </div>
            </div>

            <!-- 聊天消息区域 -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- 欢迎消息 -->
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-comments text-2xl text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">欢迎使用青邻聊天</h3>
                    <p class="text-gray-600">选择一个AI开始聊天，或在群聊中与所有AI交流</p>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="bg-white border-t border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <!-- 语音输入按钮 - 支持长按录音 -->
                    <button id="voiceInputBtn" 
                            class="bg-gray-100 text-gray-700 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-300 hover-scale">
                        <i class="fa fa-microphone"></i>
                    </button>
                    
                    <textarea id="messageInput" 
                              placeholder="输入消息... 或长按麦克风语音输入" 
                              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none min-h-[60px] max-h-[120px]"></textarea>
                    
                    <button id="sendBtn" 
                            class="bg-primary text-white p-3 rounded-lg hover:bg-secondary transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed hover-scale">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- 语音识别状态显示 -->
                <div id="voiceRecognitionStatus" class="hidden mt-2 text-center">
                    <div class="inline-flex items-center gap-2 bg-blue-50 px-4 py-2 rounded-lg">
                        <div class="voice-wave">
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                        </div>
                        <span class="text-blue-700 text-sm">正在识别语音...</span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                    <span id="charCount">0/2000</span>
                    <span id="modelInfo">群聊模式</span>
                </div>
                <div class="text-center mt-2">
                    <span id="authorInfo" class="author-text text-xs">关于作者</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div id="addAiModal" class="modal-container">
        <div class="modal-content p-6">
            <div class="modal-close-btn" id="closeAddAiModal">
                <i class="fa fa-times"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">添加AI</h3>
            
            <form id="addAiForm" class="space-y-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">模型名称</label>
                    <input type="text" id="modelName" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="例如：deepseek-ai/DeepSeek-R1" required>
                    <p class="text-xs text-gray-500 mt-1">
                        模型名称格式：组织名/模型名<br>
                        示例：deepseek-ai/DeepSeek-R1、Qwen/Qwen3-8B
                    </p>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancelAddAi" 
                            class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors hover-scale">
                        取消
                    </button>
                    <button type="submit" id="submitAddAi" 
                            class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-secondary transition-colors hover-scale">
                        添加
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 新建群聊模态框 -->
    <div id="newGroupModal" class="modal-container">
        <div class="modal-content p-6">
            <div class="modal-close-btn" id="closeNewGroupModal">
                <i class="fa fa-times"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">新建群聊</h3>
            
            <form id="newGroupForm" class="space-y-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">群聊名称</label>
                    <input type="text" id="groupName" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="请输入群聊名称" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">选择AI成员</label>
                    <div id="aiMembersList" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- AI成员选项将通过JavaScript动态添加 -->
                    </div>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancelNewGroup" 
                            class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors hover-scale">
                        取消
                    </button>
                    <button type="submit" id="submitNewGroup" 
                            class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-secondary transition-colors hover-scale">
                        创建群聊
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 群聊管理模态框 -->
    <div id="groupManagementModal" class="modal-container">
        <div class="modal-content p-6">
            <div class="modal-close-btn" id="closeGroupManagementModal">
                <i class="fa fa-times"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">群聊管理</h3>
            
            <div id="groupsListContainer" class="space-y-3 mt-4">
                <!-- 群聊列表将通过JavaScript动态添加 -->
            </div>
        </div>
    </div>

    <!-- 群聊设置模态框 -->
    <div id="groupSettingsModal" class="modal-container">
        <div class="modal-content p-6">
            <div class="modal-close-btn" id="closeGroupSettingsModal">
                <i class="fa fa-times"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">群聊设置</h3>
            
            <form id="groupSettingsForm" class="space-y-4 mt-4">
                <input type="hidden" id="currentGroupId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">群聊名称</label>
                    <input type="text" id="editGroupName" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="请输入群聊名称" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">群成员管理</label>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-2">已添加成员</label>
                            <div id="groupMembersList" class="space-y-2 max-h-40 overflow-y-auto">
                                <!-- 群成员列表将通过JavaScript动态添加 -->
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-2">添加新成员</label>
                            <div id="availableAiList" class="space-y-2 max-h-32 overflow-y-auto">
                                <!-- 可添加的AI列表将通过JavaScript动态添加 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">禁言管理</label>
                    <div id="mutedMembersList" class="space-y-2 max-h-32 overflow-y-auto">
                        <!-- 禁言成员列表将通过JavaScript动态添加 -->
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-4">
                    <button type="button" id="deleteGroupBtn" 
                            class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors hover-scale">
                        <i class="fa fa-trash mr-2"></i>
                        解散群聊
                    </button>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancelGroupSettings" 
                            class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors hover-scale">
                        取消
                    </button>
                    <button type="submit" id="saveGroupSettings" 
                            class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-secondary transition-colors hover-scale">
                        保存设置
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="modal-container">
        <div class="modal-content p-6">
            <div class="modal-close-btn" id="closeSettingsModal">
                <i class="fa fa-times"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800">设置</h3>
            
            <div class="space-y-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API密钥</label>
                    <div class="flex items-center gap-2">
                        <input type="password" id="settingsApiKey" 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="sk-xxxxxxxxxxxxxxxxxxxx">
                        <button id="showApiKeyBtn" class="text-gray-500 hover:text-gray-700 hover-scale">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">温度参数</label>
                    <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>精确</span>
                        <span id="temperatureValue">0.7</span>
                        <span>创意</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">最大长度</label>
                    <select id="maxTokensSelect" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="512">短 (512 tokens)</option>
                        <option value="1024" selected>中 (1024 tokens)</option>
                        <option value="2048">长 (2048 tokens)</option>
                        <option value="4096">超长 (4096 tokens)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">群聊设置</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="groupChatSequential" checked
                                   class="rounded border-gray-300 text-primary focus:ring-primary">
                            <span class="ml-2 text-sm text-gray-700">顺序回复（一个接一个）</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="groupChatIncludeNames" checked
                                   class="rounded border-gray-300 text-primary focus:ring-primary">
                            <span class="ml-2 text-sm text-gray-700">回复中包含模型标识</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">语音识别设置</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="autoSendAfterVoice" checked
                                   class="rounded border-gray-300 text-primary focus:ring-primary">
                            <span class="ml-2 text-sm text-gray-700">语音识别后自动发送</span>
                        </label>
                        <div class="text-xs text-gray-500 mt-1">
                            <i class="fa fa-info-circle mr-1"></i>
                            长按麦克风录音，松手自动识别并发送
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="text-sm font-semibold text-gray-800 mb-3">数据管理</h4>
                    <div class="space-y-2">
                        <button id="clearChatHistoryBtn" 
                                class="w-full text-left px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors hover-scale flex items-center gap-2">
                            <i class="fa fa-comment-o text-orange-500"></i>
                            <span>清空所有聊天记录</span>
                        </button>
                        <button id="resetAllDataBtn" 
                                class="w-full text-left px-3 py-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors hover-scale flex items-center gap-2">
                            <i class="fa fa-trash"></i>
                            <span>重置浏览器缓存（清除所有数据）</span>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center justify-end pt-2">
                    <button id="saveSettingsBtn" 
                            class="bg-primary text-white py-2 px-6 rounded-lg hover:bg-secondary transition-colors hover-scale">
                        保存设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 作者信息模态框 -->
    <div id="authorModal" class="modal-container">
        <div class="modal-content p-6">
            <div class="modal-close-btn" id="closeAuthorModal">
                <i class="fa fa-times"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-6 text-center">关于作者</h3>
            
            <div class="space-y-6">
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-pink-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-play-circle text-white text-2xl"></i>
                    </div>
                    <h4 class="font-semibold text-gray-800 mb-2">Bilibili账号</h4>
                    <a href="https://space.bilibili.com/3537105093396975" target="_blank" 
                       class="text-primary hover:text-secondary transition-colors">
                        https://space.bilibili.com/3537105093396975
                    </a>
                </div>
                
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-red-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-music text-white text-2xl"></i>
                    </div>
                    <h4 class="font-semibold text-gray-800 mb-2">抖音账号</h4>
                    <a href="https://v.douyin.com/v3g60EPGr9Y/" target="_blank" 
                       class="text-primary hover:text-secondary transition-colors block mb-2">
                        https://v.douyin.com/v3g60EPGr9Y/
                    </a>
                    <p class="text-gray-600">7@2.com :7pm</p>
                </div>
                
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-heart text-white text-2xl"></i>
                    </div>
                    <h4 class="font-semibold text-gray-800 mb-3">赞赏作者</h4>
                    <div class="bg-gray-100 rounded-lg p-4 mb-3">
                        <img src="https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/736cdd56673e4421a81bf8192870ee38.jpeg~tplv-a9rns2rl98-24:720:720.jpeg?rcl=20251018203651B0956A08A6D424C5EC30&rk3s=8e244e95&rrcfp=e9668010&x-expires=1761395811&x-signature=Xn9Njxb8HqdvkJaAbT6%2FDy87KTU%3D" 
                             alt="赞赏码" class="w-48 h-48 mx-auto rounded-lg shadow-md donation-qrcode">
                    </div>
                    <p class="text-base text-gray-700 font-medium">谢谢您的支持！</p>
                </div>
                
                <div class="text-center p-5 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border-2 border-primary/20">
                    <h4 class="font-semibold text-primary text-lg mb-3">
                        <i class="fa fa-thumbs-up mr-2"></i>
                        谢谢您的一键三连和赞助！
                    </h4>
                    <p class="text-gray-700">点赞、关注、转发和赞助是对作者最大的支持</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div id="deleteConfirmModal" class="modal-container">
        <div class="modal-content p-6">
            <div class="modal-close-btn" id="closeDeleteConfirmModal">
                <i class="fa fa-times"></i>
            </div>
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-exclamation-triangle text-2xl text-red-500"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">确认删除</h3>
                <p class="text-gray-600" id="deleteConfirmMessage">确定要删除这个AI吗？</p>
                
                <div class="flex gap-3 mt-6">
                    <button id="cancelDeleteBtn" 
                            class="flex-1 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors hover-scale">
                        取消
                    </button>
                    <button id="confirmDeleteBtn" 
                            class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition-colors hover-scale">
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 录音提示 -->
    <div id="recordingHint" class="recording-hint">
        <i class="fa fa-microphone"></i>
        <span>长按录音，松手发送</span>
    </div>

    <!-- 群聊状态提示 -->
    <div id="groupChatStatus" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg px-6 py-3 border-l-4 border-primary">
            <div class="flex items-center gap-2">
                <i class="fa fa-users text-primary"></i>
                <span id="groupChatStatusText" class="text-gray-800 font-medium">群聊进行中...</span>
            </div>
        </div>
    </div>

    <script>
        // 全局状态管理
        class ChatApp {
            constructor() {
                this.apiKey = localStorage.getItem('siliconflow_api_key') || '';
                this.currentChat = null; // 'private_aiId' 或 'group_groupId'
                this.ais = JSON.parse(localStorage.getItem('saved_ais') || '[]');
                this.groups = JSON.parse(localStorage.getItem('chat_groups') || '[]');
                this.contexts = JSON.parse(localStorage.getItem('chat_contexts') || '{}');
                this.settings = JSON.parse(localStorage.getItem('app_settings') || '{}');
                this.currentDeleteItem = { type: null, id: null };
                this.isGroupChatRunning = false;
                this.currentGroupId = null;
                
                // 语音识别相关
                this.isRecording = false;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.longPressTimer = null;
                this.longPressThreshold = 200; // 长按阈值（毫秒）
                
                // 默认设置
                this.defaultSettings = {
                    temperature: 0.7,
                    max_tokens: 1024,
                    group_sequential: true,
                    group_include_names: true,
                    auto_send_after_voice: true // 默认开启自动发送
                };
                
                this.initialize();
            }

            initialize() {
                this.applySettings();
                this.setupEventListeners();
                this.checkLoginStatus();
                this.migrateOldData();
                this.validateAndCleanupData();
                this.renderGroupList();
                this.renderAIList();
                this.selectFirstAvailableChat();
            }

            applySettings() {
                this.settings = { ...this.defaultSettings, ...this.settings };
            }

            // 迁移旧数据格式
            migrateOldData() {
                const oldContexts = JSON.parse(localStorage.getItem('chat_contexts') || '{}');
                const newContexts = {};
                
                // 迁移私聊记录
                for (const aiId in oldContexts) {
                    if (aiId !== 'group' && this.ais.some(ai => ai.id === aiId)) {
                        newContexts[`private_${aiId}`] = oldContexts[aiId];
                    }
                }
                
                // 迁移群聊记录（如果有旧的群聊记录）
                if (oldContexts.group && this.groups.length === 0) {
                    // 创建第一个群聊
                    const firstGroup = {
                        id: 'group_' + Date.now(),
                        name: '默认群聊',
                        members: this.ais.map(ai => ai.id),
                        muted: [],
                        createdAt: new Date().toISOString()
                    };
                    this.groups.push(firstGroup);
                    newContexts[firstGroup.id] = oldContexts.group;
                    
                    localStorage.setItem('chat_groups', JSON.stringify(this.groups));
                }
                
                if (Object.keys(newContexts).length > 0) {
                    localStorage.setItem('chat_contexts', JSON.stringify(newContexts));
                    this.contexts = newContexts;
                }
                
                // 清除旧的群聊上下文
                if (oldContexts.group) {
                    delete oldContexts.group;
                    localStorage.setItem('chat_contexts', JSON.stringify({ ...this.contexts, ...oldContexts }));
                }
            }

            validateAndCleanupData() {
                let cleaned = false;
                const validAiIds = this.ais.map(ai => ai.id);
                const validChatIds = ['group', ...validAiIds.map(id => `private_${id}`), ...this.groups.map(g => g.id)];
                
                // 清理群聊中的无效AI
                this.groups.forEach(group => {
                    const validMembers = group.members.filter(memberId => validAiIds.includes(memberId));
                    const validMuted = group.muted.filter(memberId => validAiIds.includes(memberId));
                    
                    if (validMembers.length !== group.members.length || validMuted.length !== group.muted.length) {
                        group.members = validMembers;
                        group.muted = validMuted;
                        cleaned = true;
                    }
                });
                
                // 清理无效的群聊
                const validGroups = this.groups.filter(group => group.members.length > 0);
                if (validGroups.length !== this.groups.length) {
                    this.groups = validGroups;
                    cleaned = true;
                }
                
                // 清理上下文
                for (const chatId in this.contexts) {
                    if (!validChatIds.includes(chatId)) {
                        delete this.contexts[chatId];
                        cleaned = true;
                        continue;
                    }
                    
                    const context = this.contexts[chatId];
                    if (!Array.isArray(context)) {
                        this.contexts[chatId] = [];
                        cleaned = true;
                        continue;
                    }
                    
                    const validMessages = [];
                    for (const msg of context) {
                        if (this.isValidMessage(msg)) {
                            validMessages.push(msg);
                        } else {
                            cleaned = true;
                        }
                    }
                    
                    if (validMessages.length !== context.length) {
                        this.contexts[chatId] = validMessages;
                        cleaned = true;
                    }
                }
                
                if (cleaned) {
                    localStorage.setItem('saved_ais', JSON.stringify(this.ais));
                    localStorage.setItem('chat_groups', JSON.stringify(this.groups));
                    localStorage.setItem('chat_contexts', JSON.stringify(this.contexts));
                    this.showNotification('检测到无效数据，已自动清理', 'info');
                }
            }

            isValidMessage(msg) {
                return msg && 
                       typeof msg === 'object' && 
                       ['user', 'assistant'].includes(msg.role) && 
                       typeof msg.content === 'string' && 
                       msg.content.trim() !== '' && 
                       typeof msg.timestamp === 'string' && 
                       !isNaN(Date.parse(msg.timestamp));
            }

            setupEventListeners() {
                // 登录相关
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                // 主界面相关
                document.getElementById('addAiBtn').addEventListener('click', () => {
                    this.showModal('addAiModal');
                });

                document.getElementById('newGroupBtn').addEventListener('click', () => {
                    this.showNewGroupModal();
                });

                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.showModal('settingsModal');
                });

                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.handleLogout();
                });

                document.getElementById('manageGroupsBtn').addEventListener('click', () => {
                    this.showGroupManagementModal();
                });

                // 聊天相关
                document.getElementById('messageInput').addEventListener('input', (e) => {
                    this.updateCharCount(e.target.value);
                });

                document.getElementById('messageInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey && !this.isGroupChatRunning && !this.isRecording) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                document.getElementById('sendBtn').addEventListener('click', () => {
                    if (!this.isGroupChatRunning && !this.isRecording) {
                        this.sendMessage();
                    }
                });

                document.getElementById('clearChatBtn').addEventListener('click', () => {
                    this.clearCurrentChat();
                });

                document.getElementById('exportChatBtn').addEventListener('click', () => {
                    this.exportChat();
                });

                document.getElementById('groupSettingsBtn').addEventListener('click', () => {
                    if (this.currentChat && this.currentChat.startsWith('group_')) {
                        this.showGroupSettingsModal(this.currentChat);
                    }
                });

                // 语音输入按钮 - 支持长按录音
                const voiceBtn = document.getElementById('voiceInputBtn');
                if (voiceBtn) {
                    // 鼠标事件
                    voiceBtn.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        this.startLongPressRecording();
                    });
                    
                    voiceBtn.addEventListener('mouseup', () => {
                        this.endLongPressRecording();
                    });
                    
                    voiceBtn.addEventListener('mouseleave', () => {
                        this.endLongPressRecording();
                    });
                    
                    // 触摸事件（移动端）
                    voiceBtn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.startLongPressRecording();
                    });
                    
                    voiceBtn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.endLongPressRecording();
                    });
                    
                    voiceBtn.addEventListener('touchcancel', (e) => {
                        e.preventDefault();
                        this.endLongPressRecording();
                    });
                }

                // 添加AI模态框
                document.getElementById('addAiForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addAI();
                });

                document.getElementById('closeAddAiModal').addEventListener('click', () => {
                    this.hideModal('addAiModal');
                });

                document.getElementById('cancelAddAi').addEventListener('click', () => {
                    this.hideModal('addAiModal');
                });

                // 新建群聊模态框
                document.getElementById('newGroupForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createGroup();
                });

                document.getElementById('closeNewGroupModal').addEventListener('click', () => {
                    this.hideModal('newGroupModal');
                });

                document.getElementById('cancelNewGroup').addEventListener('click', () => {
                    this.hideModal('newGroupModal');
                });

                // 群聊管理模态框
                document.getElementById('closeGroupManagementModal').addEventListener('click', () => {
                    this.hideModal('groupManagementModal');
                });

                // 群聊设置模态框
                document.getElementById('groupSettingsForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveGroupSettings();
                });

                document.getElementById('closeGroupSettingsModal').addEventListener('click', () => {
                    this.hideModal('groupSettingsModal');
                });

                document.getElementById('cancelGroupSettings').addEventListener('click', () => {
                    this.hideModal('groupSettingsModal');
                });

                document.getElementById('deleteGroupBtn').addEventListener('click', () => {
                    this.confirmDeleteGroup();
                });

                // 设置模态框
                document.getElementById('showApiKeyBtn').addEventListener('click', () => {
                    this.toggleApiKeyVisibility();
                });

                document.getElementById('closeSettingsModal').addEventListener('click', () => {
                    this.hideModal('settingsModal');
                });

                document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                    this.saveSettings();
                });

                document.getElementById('temperatureSlider').addEventListener('input', (e) => {
                    document.getElementById('temperatureValue').textContent = e.target.value;
                });

                document.getElementById('clearChatHistoryBtn').addEventListener('click', () => {
                    this.clearAllChatHistory();
                });

                document.getElementById('resetAllDataBtn').addEventListener('click', () => {
                    this.resetAllData();
                });

                // 删除确认模态框
                document.getElementById('closeDeleteConfirmModal').addEventListener('click', () => {
                    this.hideModal('deleteConfirmModal');
                });

                document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                    this.hideModal('deleteConfirmModal');
                });

                document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                    this.confirmDelete();
                });

                // 作者信息模态框
                document.getElementById('authorInfo').addEventListener('click', () => {
                    this.showModal('authorModal');
                });

                document.getElementById('closeAuthorModal').addEventListener('click', () => {
                    this.hideModal('authorModal');
                });

                // 点击模态框外部关闭
                this.setupModalOutsideClick();
                
                // 键盘ESC关闭弹窗
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideAllModals();
                        if (this.isRecording) {
                            this.stopVoiceRecording();
                        }
                    }
                });
            }

            setupModalOutsideClick() {
                const modals = ['addAiModal', 'newGroupModal', 'groupManagementModal', 'groupSettingsModal', 'settingsModal', 'deleteConfirmModal', 'authorModal'];
                
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.hideModal(modalId);
                        }
                    });
                });
            }

            hideAllModals() {
                const modals = ['addAiModal', 'newGroupModal', 'groupManagementModal', 'groupSettingsModal', 'settingsModal', 'deleteConfirmModal', 'authorModal'];
                modals.forEach(modalId => {
                    this.hideModal(modalId);
                });
            }

            showModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.add('show');
                
                if (modalId === 'settingsModal') {
                    this.loadSettingsIntoForm();
                }
            }

            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.remove('show');
            }

            checkLoginStatus() {
                if (this.apiKey) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainScreen').classList.remove('hidden');
                    this.updateApiKeyDisplay();
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('mainScreen').classList.add('hidden');
                }
            }

            handleLogin() {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                if (apiKey) {
                    this.apiKey = apiKey;
                    localStorage.setItem('siliconflow_api_key', apiKey);
                    this.checkLoginStatus();
                }
            }

            handleLogout() {
                if (confirm('确定要退出登录吗？')) {
                    localStorage.removeItem('siliconflow_api_key');
                    this.apiKey = '';
                    this.checkLoginStatus();
                }
            }

            selectFirstAvailableChat() {
                if (this.groups.length > 0) {
                    this.switchChat(this.groups[0].id);
                } else if (this.ais.length > 0) {
                    this.switchChat(`private_${this.ais[0].id}`);
                }
            }

            // AI管理功能
            addAI() {
                const model = document.getElementById('modelName').value.trim();

                if (!model) {
                    alert('请输入模型名称');
                    return;
                }

                if (!model.includes('/')) {
                    if (!confirm('模型名称似乎不包含"/"，格式应为"组织名/模型名"。确定要使用这个模型名称吗？')) {
                        return;
                    }
                }

                const shortModelName = this.formatModelName(model);
                
                const ai = {
                    id: Date.now().toString(),
                    model: model,
                    displayName: shortModelName,
                    createdAt: new Date().toISOString()
                };

                this.ais.push(ai);
                localStorage.setItem('saved_ais', JSON.stringify(this.ais));
                this.renderAIList();
                this.hideModal('addAiModal');
                this.updateGroupLists();
                
                this.showNotification('AI添加成功！', 'success');
            }

            showDeleteConfirmModal(type, id, name) {
                this.currentDeleteItem = { type, id };
                const message = type === 'ai' ? 
                    `确定要删除"${name}"吗？删除后相关聊天记录也会被清除。` :
                    `确定要解散群聊"${name}"吗？所有聊天记录将被清除。`;
                
                document.getElementById('deleteConfirmMessage').textContent = message;
                this.showModal('deleteConfirmModal');
            }

            confirmDelete() {
                if (this.currentDeleteItem.type === 'ai') {
                    this.deleteAI(this.currentDeleteItem.id);
                } else if (this.currentDeleteItem.type === 'group') {
                    this.deleteGroup(this.currentDeleteItem.id);
                }
                this.hideModal('deleteConfirmModal');
            }

            deleteAI(aiId) {
                const ai = this.ais.find(a => a.id === aiId);
                if (ai) {
                    // 从所有群聊中移除这个AI
                    this.groups.forEach(group => {
                        group.members = group.members.filter(id => id !== aiId);
                        group.muted = group.muted.filter(id => id !== aiId);
                    });
                    
                    // 删除AI
                    this.ais = this.ais.filter(a => a.id !== aiId);
                    
                    // 删除相关聊天记录
                    const privateChatId = `private_${aiId}`;
                    if (this.contexts[privateChatId]) {
                        delete this.contexts[privateChatId];
                    }
                    
                    // 如果当前正在聊天的是这个AI，切换到其他聊天
                    if (this.currentChat === privateChatId) {
                        this.selectFirstAvailableChat();
                    }
                    
                    localStorage.setItem('saved_ais', JSON.stringify(this.ais));
                    localStorage.setItem('chat_groups', JSON.stringify(this.groups));
                    localStorage.setItem('chat_contexts', JSON.stringify(this.contexts));
                    
                    this.renderAIList();
                    this.renderGroupList();
                    this.updateGroupLists();
                    
                    this.showNotification(`"${ai.displayName}"已删除`, 'success');
                }
            }

            // 群聊管理功能
            showNewGroupModal() {
                this.renderAIMembersList();
                this.showModal('newGroupModal');
            }

            renderAIMembersList() {
                const container = document.getElementById('aiMembersList');
                container.innerHTML = '';

                if (this.ais.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">暂无可用AI，请先添加AI</p>';
                    return;
                }

                this.ais.forEach(ai => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    div.innerHTML = `
                        <input type="checkbox" id="ai_${ai.id}" value="${ai.id}" 
                               class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="ai_${ai.id}" class="text-sm text-gray-700 flex-1">${ai.displayName}</label>
                    `;
                    container.appendChild(div);
                });
            }

            createGroup() {
                const groupName = document.getElementById('groupName').value.trim();
                if (!groupName) {
                    alert('请输入群聊名称');
                    return;
                }

                const selectedAis = Array.from(document.querySelectorAll('#aiMembersList input[type="checkbox"]:checked'))
                    .map(input => input.value);

                if (selectedAis.length === 0) {
                    alert('请至少选择一个AI加入群聊');
                    return;
                }

                const group = {
                    id: 'group_' + Date.now(),
                    name: groupName,
                    members: selectedAis,
                    muted: [],
                    createdAt: new Date().toISOString()
                };

                this.groups.push(group);
                localStorage.setItem('chat_groups', JSON.stringify(this.groups));
                
                this.renderGroupList();
                this.hideModal('newGroupModal');
                this.switchChat(group.id);
                
                this.showNotification(`群聊"${groupName}"创建成功！`, 'success');
            }

            showGroupManagementModal() {
                const container = document.getElementById('groupsListContainer');
                container.innerHTML = '';

                if (this.groups.length === 0) {
                    container.innerHTML = '<p class="text-center py-4 text-gray-500">暂无群聊</p>';
                    this.showModal('groupManagementModal');
                    return;
                }

                this.groups.forEach(group => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors';
                    
                    const aiNames = group.members.map(id => {
                        const ai = this.ais.find(a => a.id === id);
                        return ai ? ai.displayName : '未知AI';
                    }).join(', ');
                    
                    groupDiv.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800 truncate-text">${group.name}</div>
                            <div class="text-xs text-gray-500 truncate-text">${aiNames}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="app.switchChat('${group.id}')" 
                                    class="p-2 text-primary hover:bg-primary/10 rounded-lg transition-colors">
                                <i class="fa fa-comments"></i>
                            </button>
                            <button onclick="app.showGroupSettingsModal('${group.id}')" 
                                    class="p-2 text-gray-500 hover:bg-gray-200 rounded-lg transition-colors">
                                <i class="fa fa-cog"></i>
                            </button>
                            <button onclick="app.showDeleteConfirmModal('group', '${group.id}', '${group.name}')" 
                                    class="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(groupDiv);
                });

                this.showModal('groupManagementModal');
            }

            showGroupSettingsModal(groupId) {
                const group = this.groups.find(g => g.id === groupId);
                if (!group) return;

                document.getElementById('currentGroupId').value = groupId;
                document.getElementById('editGroupName').value = group.name;

                this.renderGroupMembersList(group);
                this.renderAvailableAIList(group);
                this.renderMutedMembersList(group);

                this.showModal('groupSettingsModal');
            }

            renderGroupMembersList(group) {
                const container = document.getElementById('groupMembersList');
                container.innerHTML = '';

                group.members.forEach(memberId => {
                    const ai = this.ais.find(a => a.id === memberId);
                    if (!ai) return;

                    const isMuted = group.muted.includes(memberId);
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
                    memberDiv.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-semibold text-xs">${ai.displayName.charAt(0).toUpperCase()}</span>
                            </div>
                            <span class="text-sm text-gray-700">${ai.displayName}</span>
                            ${isMuted ? '<i class="fa fa-volume-off text-gray-400 text-xs ml-2"></i>' : ''}
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="app.toggleMuteMember('${group.id}', '${memberId}', ${!isMuted})" 
                                    class="p-1 text-xs ${isMuted ? 'text-green-500 hover:bg-green-100' : 'text-orange-500 hover:bg-orange-100'} rounded">
                                ${isMuted ? '解除禁言' : '禁言'}
                            </button>
                            <button onclick="app.removeMemberFromGroup('${group.id}', '${memberId}')" 
                                    class="p-1 text-xs text-red-500 hover:bg-red-100 rounded">
                                移除
                            </button>
                        </div>
                    `;
                    container.appendChild(memberDiv);
                });

                if (group.members.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">暂无群成员</p>';
                }
            }

            renderAvailableAIList(group) {
                const container = document.getElementById('availableAiList');
                container.innerHTML = '';

                const availableAis = this.ais.filter(ai => !group.members.includes(ai.id));
                if (availableAis.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">所有AI都已加入群聊</p>';
                    return;
                }

                availableAis.forEach(ai => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2';
                    div.innerHTML = `
                        <input type="checkbox" id="add_ai_${ai.id}" value="${ai.id}" 
                               class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="add_ai_${ai.id}" class="text-sm text-gray-700 flex-1">${ai.displayName}</label>
                    `;
                    container.appendChild(div);
                });
            }

            renderMutedMembersList(group) {
                const container = document.getElementById('mutedMembersList');
                container.innerHTML = '';

                if (group.muted.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">暂无禁言成员</p>';
                    return;
                }

                group.muted.forEach(memberId => {
                    const ai = this.ais.find(a => a.id === memberId);
                    if (!ai) return;

                    const mutedDiv = document.createElement('div');
                    mutedDiv.className = 'flex items-center justify-between p-2 bg-orange-50 rounded-lg';
                    mutedDiv.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-gradient-to-br from-orange-400 to-red-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-semibold text-xs">${ai.displayName.charAt(0).toUpperCase()}</span>
                            </div>
                            <span class="text-sm text-gray-700">${ai.displayName}</span>
                            <i class="fa fa-volume-off text-orange-500 text-xs ml-2"></i>
                        </div>
                        <button onclick="app.toggleMuteMember('${group.id}', '${memberId}', false)" 
                                class="p-1 text-xs text-green-500 hover:bg-green-100 rounded">
                            解除禁言
                        </button>
                    `;
                    container.appendChild(mutedDiv);
                });
            }

            toggleMuteMember(groupId, memberId, mute) {
                const group = this.groups.find(g => g.id === groupId);
                if (!group) return;

                if (mute) {
                    if (!group.muted.includes(memberId)) {
                        group.muted.push(memberId);
                    }
                } else {
                    group.muted = group.muted.filter(id => id !== memberId);
                }

                localStorage.setItem('chat_groups', JSON.stringify(this.groups));
                this.showGroupSettingsModal(groupId);
            }

            removeMemberFromGroup(groupId, memberId) {
                const group = this.groups.find(g => g.id === groupId);
                if (!group) return;

                group.members = group.members.filter(id => id !== memberId);
                group.muted = group.muted.filter(id => id !== memberId);

                // 如果群聊没有成员了，删除群聊
                if (group.members.length === 0) {
                    this.deleteGroup(groupId);
                    this.hideModal('groupSettingsModal');
                    return;
                }

                localStorage.setItem('chat_groups', JSON.stringify(this.groups));
                this.showGroupSettingsModal(groupId);
            }

            saveGroupSettings() {
                const groupId = document.getElementById('currentGroupId').value;
                const groupName = document.getElementById('editGroupName').value.trim();
                const group = this.groups.find(g => g.id === groupId);
                
                if (!group || !groupName) return;

                // 更新群聊名称
                group.name = groupName;

                // 添加新成员
                const selectedAis = Array.from(document.querySelectorAll('#availableAiList input[type="checkbox"]:checked'))
                    .map(input => input.value);
                
                selectedAis.forEach(aiId => {
                    if (!group.members.includes(aiId)) {
                        group.members.push(aiId);
                    }
                });

                localStorage.setItem('chat_groups', JSON.stringify(this.groups));
                
                this.renderGroupList();
                this.hideModal('groupSettingsModal');
                this.updateChatHeader();
                
                this.showNotification('群聊设置已保存', 'success');
            }

            deleteGroup(groupId) {
                const groupIndex = this.groups.findIndex(g => g.id === groupId);
                if (groupIndex === -1) return;

                const groupName = this.groups[groupIndex].name;
                
                // 删除群聊上下文
                if (this.contexts[groupId]) {
                    delete this.contexts[groupId];
                }

                // 如果当前正在聊天的是这个群聊，切换到其他聊天
                if (this.currentChat === groupId) {
                    this.selectFirstAvailableChat();
                }

                this.groups.splice(groupIndex, 1);
                localStorage.setItem('chat_groups', JSON.stringify(this.groups));
                localStorage.setItem('chat_contexts', JSON.stringify(this.contexts));
                
                this.renderGroupList();
                this.hideModal('groupSettingsModal');
                
                this.showNotification(`群聊"${groupName}"已解散`, 'success');
            }

            confirmDeleteGroup() {
                const groupId = document.getElementById('currentGroupId').value;
                const group = this.groups.find(g => g.id === groupId);
                if (group) {
                    this.showDeleteConfirmModal('group', groupId, group.name);
                }
            }

            // 渲染函数
            renderGroupList() {
                const container = document.getElementById('groupList');
                container.innerHTML = '';

                if (this.groups.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <i class="fa fa-users text-xl mb-2"></i>
                            <p class="text-sm">暂无群聊</p>
                            <p class="text-xs mt-1">点击"+"创建群聊</p>
                        </div>
                    `;
                    return;
                }

                this.groups.forEach(group => {
                    const isActive = this.currentChat === group.id;
                    const groupItem = document.createElement('button');
                    groupItem.className = `w-full flex items-center justify-between p-3 rounded-lg transition-all duration-300 hover-scale ${
                        isActive ? 'bg-primary/10 text-primary border-l-4 border-primary' : 'hover:bg-gray-100 text-gray-700 border-l-4 border-transparent'
                    }`;
                    groupItem.onclick = () => this.switchChat(group.id);
                    
                    const memberCount = group.members.length;
                    const onlineMembers = group.members.filter(id => !group.muted.includes(id)).length;
                    
                    groupItem.innerHTML = `
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-lg flex items-center justify-center">
                                <i class="fa fa-users text-white"></i>
                            </div>
                            <div class="text-left flex-1 min-w-0">
                                <div class="font-medium truncate-text">${group.name}</div>
                                <div class="text-xs text-gray-500">
                                    ${onlineMembers}/${memberCount} 在线
                                    ${group.muted.length > 0 ? `(${group.muted.length} 禁言)` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="event.stopPropagation(); app.showGroupSettingsModal('${group.id}')" 
                                    class="p-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded">
                                <i class="fa fa-cog text-xs"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(groupItem);
                });
            }

            renderAIList() {
                const aiList = document.getElementById('aiList');
                aiList.innerHTML = '';

                if (this.ais.length === 0) {
                    aiList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fa fa-robot text-2xl mb-2"></i>
                            <p>暂无添加的AI</p>
                            <p class="text-xs mt-1">点击"添加AI"按钮开始</p>
                        </div>
                    `;
                    return;
                }

                this.ais.forEach(ai => {
                    const chatId = `private_${ai.id}`;
                    const isActive = this.currentChat === chatId;
                    const aiItem = document.createElement('div');
                    aiItem.className = `w-full flex items-center justify-between p-3 rounded-lg transition-all duration-300 hover-scale ${
                        isActive ? 'bg-primary/10 text-primary border-l-4 border-primary' : 'hover:bg-gray-100 text-gray-700 border-l-4 border-transparent'
                    }`;
                    
                    const shortModelName = this.formatShortModelName(ai.model);
                    
                    aiItem.innerHTML = `
                        <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="app.switchChat('${chatId}')">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg flex items-center justify-center">
                                <span class="text-white font-semibold">${ai.displayName.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="text-left flex-1 min-w-0">
                                <div class="font-medium truncate-text">${ai.displayName}</div>
                                <div class="text-xs text-gray-500 truncate-text">${shortModelName}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="delete-ai-btn p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors hover-scale" 
                                    onclick="event.stopPropagation(); app.showDeleteConfirmModal('ai', '${ai.id}', '${ai.displayName}')">
                                <i class="fa fa-trash text-sm"></i>
                            </button>
                        </div>
                    `;

                    aiList.appendChild(aiItem);
                });
            }

            updateGroupLists() {
                this.groups.forEach(group => {
                    // 不需要自动添加新AI到任何群聊
                });
                this.renderGroupList();
            }

            switchChat(chatId) {
                this.currentChat = chatId;
                this.loadCurrentChat();
                this.updateChatHeader();
                this.renderGroupList();
                this.renderAIList();
                document.getElementById('messageInput').focus();
            }

            updateChatHeader() {
                const avatar = document.getElementById('currentChatAvatar');
                const title = document.getElementById('currentChatTitle');
                const subtitle = document.getElementById('currentChatSubtitle');
                const modelInfo = document.getElementById('modelInfo');
                const groupSettingsBtn = document.getElementById('groupSettingsBtn');

                if (this.currentChat && this.currentChat.startsWith('group_')) {
                    const group = this.groups.find(g => g.id === this.currentChat);
                    if (group) {
                        avatar.innerHTML = '<i class="fa fa-users text-white"></i>';
                        avatar.className = 'w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-lg flex items-center justify-center';
                        title.textContent = group.name;
                        subtitle.textContent = `${group.members.length}个成员，${group.muted.length}个禁言`;
                        modelInfo.textContent = `群聊模式 (${group.members.length}个AI)`;
                        groupSettingsBtn.classList.remove('hidden');
                    }
                } else if (this.currentChat && this.currentChat.startsWith('private_')) {
                    const aiId = this.currentChat.replace('private_', '');
                    const ai = this.ais.find(a => a.id === aiId);
                    if (ai) {
                        avatar.innerHTML = `<span class="text-white font-semibold">${ai.displayName.charAt(0).toUpperCase()}</span>`;
                        avatar.className = 'w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg flex items-center justify-center';
                        title.textContent = ai.displayName;
                        subtitle.textContent = this.getFullModelName(ai.model);
                        const shortModelName = this.formatShortModelName(ai.model);
                        modelInfo.textContent = `模型: ${shortModelName}`;
                        groupSettingsBtn.classList.add('hidden');
                    }
                }
            }

            // 聊天功能
            getCurrentContext() {
                if (!this.currentChat || !this.contexts[this.currentChat]) {
                    this.contexts[this.currentChat] = [];
                }
                return this.contexts[this.currentChat];
            }

            addToContext(role, content, sender = '') {
                const context = this.getCurrentContext();
                const message = {
                    role,
                    content,
                    timestamp: new Date().toISOString(),
                    sender
                };
                
                context.push(message);
                
                if (context.length > 40) {
                    context.splice(0, context.length - 40);
                }
                
                this.saveContexts();
                return message;
            }

            saveContexts() {
                localStorage.setItem('chat_contexts', JSON.stringify(this.contexts));
            }

            loadCurrentChat() {
                const messagesContainer = document.getElementById('chatMessages');
                const context = this.getCurrentContext();

                if (context.length === 0) {
                    let emptyState = '';
                    if (this.currentChat && this.currentChat.startsWith('group_')) {
                        const group = this.groups.find(g => g.id === this.currentChat);
                        if (group) {
                            const activeMembers = group.members.filter(id => !group.muted.includes(id));
                            emptyState = `
                                <div class="text-center py-8">
                                    <div class="w-16 h-16 bg-gradient-to-br from-primary to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fa fa-users text-2xl text-white"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold group-chat-header mb-2">${group.name}</h3>
                                    <p class="text-gray-600">与群成员一起聊天吧</p>
                                    ${activeMembers.length === 0 ? '<p class="text-sm text-orange-500 mt-2">提示：所有成员都被禁言了</p>' : ''}
                                </div>
                            `;
                        }
                    } else if (this.currentChat && this.currentChat.startsWith('private_')) {
                        const aiId = this.currentChat.replace('private_', '');
                        const ai = this.ais.find(a => a.id === aiId);
                        if (ai) {
                            emptyState = `
                                <div class="text-center py-8">
                                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fa fa-comments text-2xl text-gray-400"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">开始聊天吧</h3>
                                    <p class="text-gray-600">输入消息与${ai.displayName}交流</p>
                                </div>
                            `;
                        }
                    }
                    messagesContainer.innerHTML = emptyState;
                    return;
                }

                messagesContainer.innerHTML = '';
                context.forEach(message => {
                    this.renderMessage(message);
                });

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            renderMessage(message) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'fade-in';

                if (message.role === 'user') {
                    messageDiv.innerHTML = `
                        <div class="flex items-start justify-end gap-3">
                            <div class="chat-bubble user-bubble bg-primary text-white p-4 rounded-lg hover-scale">
                                <div class="prose prose-sm max-w-none">${this.formatMessage(message.content)}</div>
                                <div class="text-xs opacity-75 mt-1 text-right">
                                    ${this.formatTime(message.timestamp)}
                                </div>
                            </div>
                            <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0 hover-scale">
                                <i class="fa fa-bullseye text-gray-600 text-sm"></i>
                            </div>
                        </div>
                    `;
                } else {
                    const ai = this.ais.find(a => a.id === message.sender) || {
                        displayName: 'AI',
                        model: 'unknown'
                    };
                    
                    const shortModelName = this.formatShortModelName(ai.model);
                    const isMuted = this.currentChat.startsWith('group_') && 
                                  this.groups.find(g => g.id === this.currentChat)?.muted.includes(ai.id);
                    
                    messageDiv.className = `fade-in ${isMuted ? 'muted-ai' : ''}`;
                    
                    messageDiv.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0 hover-scale">
                                <span class="text-white font-semibold text-xs">${ai.displayName.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-medium text-gray-800">${ai.displayName}</span>
                                    <span class="text-xs text-gray-400">${shortModelName}</span>
                                </div>
                                <div class="chat-bubble ai-bubble bg-gray-100 text-gray-800 p-4 rounded-lg hover-scale">
                                    <div class="prose prose-sm max-w-none">${this.formatMessage(message.content)}</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        ${this.formatTime(message.timestamp)}
                                        ${isMuted ? '<span class="ml-2 text-orange-500">（已禁言）</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const content = input.value.trim();

                if (!content) return;
                if (!this.apiKey) {
                    alert('请先登录');
                    return;
                }

                if (!this.currentChat) {
                    alert('请先选择一个聊天对象');
                    return;
                }

                input.value = '';
                this.updateCharCount('');

                const userMessage = this.addToContext('user', content);
                this.renderMessage(userMessage);

                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';

                try {
                    if (this.currentChat.startsWith('group_')) {
                        await this.sendGroupMessage(content);
                    } else {
                        await this.sendPrivateMessage(content);
                    }
                } catch (error) {
                    console.error('发送消息失败:', error);
                    const errorMessage = error.message || 'API调用失败，请检查网络连接或API密钥';
                    this.addToContext('assistant', `抱歉，${errorMessage}。`);
                    this.loadCurrentChat();
                    this.showNotification(`发送失败: ${errorMessage}`, 'error');
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fa fa-paper-plane"></i>';
                    this.isGroupChatRunning = false;
                    this.hideGroupChatStatus();
                }
            }

            async sendPrivateMessage(content) {
                const aiId = this.currentChat.replace('private_', '');
                const ai = this.ais.find(a => a.id === aiId);
                if (!ai) return;

                const messagesContainer = document.getElementById('chatMessages');
                const typingDiv = this.createTypingIndicator(ai);
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                try {
                    const response = await this.callSiliconFlowAPI(ai.model, content);
                    typingDiv.remove();
                    
                    const aiMessage = this.addToContext('assistant', response, ai.id);
                    this.renderMessage(aiMessage);
                } catch (error) {
                    typingDiv.remove();
                    throw error;
                }
            }

            async sendGroupMessage(content) {
                const group = this.groups.find(g => g.id === this.currentChat);
                if (!group) return;

                this.isGroupChatRunning = true;
                const activeMembers = group.members.filter(id => !group.muted.includes(id));
                
                if (activeMembers.length === 0) {
                    this.addToContext('assistant', '群聊中没有活跃成员，无法发送消息。');
                    this.loadCurrentChat();
                    this.isGroupChatRunning = false;
                    return;
                }

                this.showGroupChatStatus(`群聊进行中，${activeMembers.length}个AI正在回复...`);

                try {
                    if (this.settings.group_sequential) {
                        for (let i = 0; i < activeMembers.length; i++) {
                            const aiId = activeMembers[i];
                            const ai = this.ais.find(a => a.id === aiId);
                            if (ai) {
                                await this.sendGroupMessageToAI(ai, content, i + 1, activeMembers.length);
                            }
                        }
                    } else {
                        const promises = activeMembers.map((aiId, index) => {
                            const ai = this.ais.find(a => a.id === aiId);
                            if (ai) {
                                return this.sendGroupMessageToAI(ai, content, index + 1, activeMembers.length);
                            }
                            return Promise.resolve(null);
                        });
                        await Promise.all(promises);
                    }

                    this.showNotification('群聊回复完成！', 'success');
                } catch (error) {
                    console.error('群聊消息发送失败:', error);
                    throw error;
                }
            }

            async sendGroupMessageToAI(ai, content, current, total) {
                const messagesContainer = document.getElementById('chatMessages');
                const typingDiv = this.createTypingIndicator(ai, `(${current}/${total})`);
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                try {
                    const groupContext = this.getCurrentContext();
                    const formattedContext = [];
                    
                    // 改进：保持原始消息内容，不在上下文中添加[AI名称]前缀
                    for (const msg of groupContext) {
                        formattedContext.push({
                            role: msg.role,
                            content: msg.content
                        });
                    }

                    formattedContext.push({
                        role: 'user',
                        content: content
                    });

                    // 改进：更清晰的系统提示，避免AI模仿格式
                    const systemPrompt = `
你是${ai.displayName}，正在参与群聊。
群聊中有其他AI：${this.groups.find(g => g.id === this.currentChat)?.members
                        .filter(id => id !== ai.id)
                        .map(id => {
                            const memberAi = this.ais.find(a => a.id === id);
                            return memberAi ? memberAi.displayName : '未知AI';
                        }).join('、') || '没有其他AI'}。

请直接回答问题，不需要在回复前添加你的名字或任何标识前缀。
保持回答简洁明了，体现你作为${ai.displayName}的特点。
不要重复其他AI可能会说的内容，尽量提供独特的视角。
                    `.trim();

                    formattedContext.unshift({
                        role: 'system',
                        content: systemPrompt
                    });

                    const response = await this.callSiliconFlowAPI(
                        ai.model,
                        '',
                        formattedContext
                    );

                    typingDiv.remove();
                    
                    // 改进：不再自动添加AI名称前缀，让AI自然回复
                    let finalResponse = response;
                    
                    // 如果AI回复中包含了自己的名字，我们可以选择保留或移除
                    // 这里选择保留，因为有些AI可能会自然地提到自己
                    
                    const aiMessage = this.addToContext('assistant', finalResponse, ai.id);
                    this.renderMessage(aiMessage);

                    return response;
                } catch (error) {
                    typingDiv.remove();
                    const errorMessage = `抱歉，${ai.displayName}暂时无法回复：${error.message}`;
                    const aiMessage = this.addToContext('assistant', errorMessage, ai.id);
                    this.renderMessage(aiMessage);
                    return null;
                }
            }

            async callSiliconFlowAPI(model, content, customContext = null) {
                const url = 'https://api.siliconflow.cn/v1/chat/completions';
                
                let messages;
                if (customContext) {
                    messages = customContext;
                } else {
                    const context = this.getCurrentContext();
                    messages = context.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));
                    if (content) {
                        messages.push({
                            role: 'user',
                            content: content
                        });
                    }
                }

                const payload = {
                    model: model,
                    messages: messages,
                    temperature: this.settings.temperature,
                    max_tokens: this.settings.max_tokens,
                    stream: false
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `API请求失败: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            // 语音识别功能 - 长按录音
            startLongPressRecording() {
                // 显示长按提示
                this.showRecordingHint(true);
                
                // 设置定时器，超过阈值后开始录音
                this.longPressTimer = setTimeout(async () => {
                    await this.startVoiceRecording();
                }, this.longPressThreshold);
            }

            endLongPressRecording() {
                // 清除定时器
                if (this.longPressTimer) {
                    clearTimeout(this.longPressTimer);
                    this.longPressTimer = null;
                }
                
                // 隐藏长按提示
                this.showRecordingHint(false);
                
                // 如果正在录音，停止录音
                if (this.isRecording) {
                    this.stopVoiceRecording();
                }
            }

            async startVoiceRecording() {
                try {
                    // 检查浏览器支持
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('您的浏览器不支持语音录制功能');
                    }

                    // 获取麦克风权限
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // 创建MediaRecorder
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];
                    
                    // 监听数据可用事件
                    this.mediaRecorder.addEventListener('dataavailable', (event) => {
                        this.audioChunks.push(event.data);
                    });
                    
                    // 监听录制结束事件
                    this.mediaRecorder.addEventListener('stop', () => {
                        this.processAudioRecording();
                        // 停止所有音轨
                        stream.getTracks().forEach(track => track.stop());
                    });
                    
                    // 开始录制
                    this.mediaRecorder.start();
                    this.isRecording = true;
                    
                    // 更新UI
                    this.updateVoiceRecordingUI(true);
                    
                } catch (error) {
                    console.error('录音启动失败:', error);
                    this.showNotification(`录音启动失败: ${error.message}`, 'error');
                    this.showRecordingHint(false);
                }
            }

            stopVoiceRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    this.updateVoiceRecordingUI(false);
                    this.showNotification('正在识别语音...', 'info');
                }
            }

            async processAudioRecording() {
                try {
                    // 创建音频Blob
                    const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                    
                    // 显示处理中状态
                    this.showVoiceRecognitionStatus(true);
                    
                    // 调用语音识别API
                    const transcription = await this.callVoiceRecognitionAPI(audioBlob);
                    
                    // 隐藏处理状态
                    this.showVoiceRecognitionStatus(false);
                    
                    if (transcription) {
                        // 将识别结果填入输入框
                        const messageInput = document.getElementById('messageInput');
                        messageInput.value = transcription;
                        this.updateCharCount(transcription);
                        
                        this.showNotification('语音识别完成！', 'success');
                        
                        // 如果设置了自动发送，延迟一秒后发送
                        if (this.settings.auto_send_after_voice) {
                            setTimeout(() => {
                                this.sendMessage();
                            }, 1000);
                        }
                    } else {
                        this.showNotification('未识别到语音内容', 'warning');
                    }
                    
                } catch (error) {
                    console.error('语音处理失败:', error);
                    this.showVoiceRecognitionStatus(false);
                    this.showNotification(`语音识别失败: ${error.message}`, 'error');
                }
            }

            async callVoiceRecognitionAPI(audioBlob) {
                try {
                    const formData = new FormData();
                    formData.append('model', 'FunAudioLLM/SenseVoiceSmall');
                    formData.append('file', audioBlob, 'recording.wav');
                    
                    const response = await fetch('https://api.siliconflow.cn/v1/audio/transcriptions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || `API请求失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.text || '';
                    
                } catch (error) {
                    console.error('语音识别API调用失败:', error);
                    throw error;
                }
            }

            updateVoiceRecordingUI(isRecording) {
                const voiceBtn = document.getElementById('voiceInputBtn');
                
                if (isRecording) {
                    voiceBtn.innerHTML = '<i class="fa fa-microphone text-white"></i>';
                    voiceBtn.className = 'bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition-all duration-300 recording-pulse';
                } else {
                    voiceBtn.innerHTML = '<i class="fa fa-microphone"></i>';
                    voiceBtn.className = 'bg-gray-100 text-gray-700 p-3 rounded-lg hover:bg-gray-200 transition-colors duration-300 hover-scale';
                }
            }

            showVoiceRecognitionStatus(show) {
                const statusDiv = document.getElementById('voiceRecognitionStatus');
                if (show) {
                    statusDiv.classList.remove('hidden');
                } else {
                    statusDiv.classList.add('hidden');
                }
            }

            showRecordingHint(show) {
                const hint = document.getElementById('recordingHint');
                if (show) {
                    hint.classList.add('show');
                } else {
                    hint.classList.remove('show');
                }
            }

            // 工具函数
            formatModelName(modelName) {
                if (!modelName) return '未知模型';
                
                let displayName = modelName;
                if (modelName.includes('/')) {
                    const parts = modelName.split('/');
                    displayName = parts[parts.length - 1];
                }
                
                if (displayName.length > 14) {
                    displayName = displayName.substring(0, 14) + '...';
                }
                
                return displayName;
            }

            getFullModelName(modelName) {
                if (!modelName) return '未知模型';
                return modelName;
            }

            formatShortModelName(modelName) {
                if (!modelName) return '未知';
                
                let shortName = modelName;
                if (modelName.includes('/')) {
                    const parts = modelName.split('/');
                    shortName = parts[parts.length - 1];
                }
                
                if (shortName.length > 10) {
                    shortName = shortName.substring(0, 10) + '...';
                }
                
                return shortName;
            }

            formatMessage(content) {
                return content
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code class="bg-gray-200 px-1 py-0.5 rounded text-sm">$1</code>')
                    .replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-200 p-3 rounded text-sm overflow-x-auto"><code>$1</code></pre>');
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            createTypingIndicator(ai, extraText = '') {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'flex items-start gap-3 fade-in';
                
                const shortModelName = this.formatShortModelName(ai.model);
                
                typingDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white font-semibold text-xs">${ai.displayName.charAt(0).toUpperCase()}</span>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-gray-800">${ai.displayName}${extraText}</span>
                            <span class="text-xs text-gray-400">${shortModelName}</span>
                        </div>
                        <div class="chat-bubble ai-bubble bg-gray-100 text-gray-800 p-4 rounded-lg">
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                `;
                
                return typingDiv;
            }

            updateCharCount(content) {
                const count = content.length;
                const maxCount = 2000;
                const charCount = document.getElementById('charCount');
                charCount.textContent = `${count}/${maxCount}`;
                
                if (count > maxCount) {
                    charCount.className = 'text-red-500';
                } else {
                    charCount.className = 'text-gray-500';
                }
            }

            clearCurrentChat() {
                if (confirm('确定要清空当前聊天记录吗？')) {
                    if (this.currentChat) {
                        this.contexts[this.currentChat] = [];
                        this.saveContexts();
                        this.loadCurrentChat();
                        this.showNotification('聊天记录已清空', 'success');
                    }
                }
            }

            clearAllChatHistory() {
                if (confirm('确定要清空所有聊天记录吗？此操作不会删除AI配置和群聊设置。')) {
                    for (const chatId in this.contexts) {
                        this.contexts[chatId] = [];
                    }
                    this.saveContexts();
                    this.loadCurrentChat();
                    this.showNotification('所有聊天记录已清空', 'success');
                    this.hideModal('settingsModal');
                }
            }

            resetAllData() {
                if (confirm('确定要重置所有数据吗？此操作将清除：\n\n• 所有AI配置\n• 所有群聊设置\n• 所有聊天记录\n• API密钥\n• 应用设置\n\n操作不可撤销！')) {
                    localStorage.clear();
                    
                    this.apiKey = '';
                    this.ais = [];
                    this.groups = [];
                    this.contexts = {};
                    this.settings = {};
                    this.currentChat = null;
                    
                    this.applySettings();
                    this.renderGroupList();
                    this.renderAIList();
                    this.loadCurrentChat();
                    this.updateChatHeader();
                    this.updateApiKeyDisplay();
                    
                    this.showNotification('所有数据已重置', 'success');
                    this.hideModal('settingsModal');
                }
            }

            exportChat() {
                if (!this.currentChat) {
                    alert('请先选择一个聊天');
                    return;
                }

                const context = this.getCurrentContext();
                if (context.length === 0) {
                    alert('没有聊天记录可导出');
                    return;
                }

                let chatTitle = '聊天记录';
                if (this.currentChat.startsWith('group_')) {
                    const group = this.groups.find(g => g.id === this.currentChat);
                    chatTitle = group ? group.name : '群聊';
                } else if (this.currentChat.startsWith('private_')) {
                    const aiId = this.currentChat.replace('private_', '');
                    const ai = this.ais.find(a => a.id === aiId);
                    chatTitle = ai ? ai.displayName : '私聊';
                }
                
                let content = `青邻聊天 - ${chatTitle} - ${new Date().toLocaleString()}\n\n`;
                
                context.forEach(msg => {
                    const time = this.formatTime(msg.timestamp);
                    if (msg.role === 'user') {
                        content += `我 (${time}):\n${msg.content}\n\n`;
                    } else {
                        const ai = this.ais.find(a => a.id === msg.sender) || { displayName: 'AI' };
                        content += `${ai.displayName} (${time}):\n${msg.content}\n\n`;
                    }
                });

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${chatTitle}_${new Date().getTime()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showNotification('聊天记录已导出', 'success');
            }

            saveSettings() {
                try {
                    const newApiKey = document.getElementById('settingsApiKey').value.trim();
                    const temperature = parseFloat(document.getElementById('temperatureSlider').value);
                    const maxTokens = parseInt(document.getElementById('maxTokensSelect').value);
                    const groupSequential = document.getElementById('groupChatSequential').checked;
                    const groupIncludeNames = document.getElementById('groupChatIncludeNames').checked;
                    const autoSendAfterVoice = document.getElementById('autoSendAfterVoice').checked;

                    if (newApiKey && newApiKey !== this.apiKey) {
                        this.apiKey = newApiKey;
                        localStorage.setItem('siliconflow_api_key', newApiKey);
                        this.updateApiKeyDisplay();
                    }

                    const newSettings = {
                        ...this.settings,
                        temperature,
                        max_tokens: maxTokens,
                        group_sequential: groupSequential,
                        group_include_names: groupIncludeNames,
                        auto_send_after_voice: autoSendAfterVoice
                    };

                    this.settings = newSettings;
                    localStorage.setItem('app_settings', JSON.stringify(this.settings));
                    
                    this.hideModal('settingsModal');
                    this.updateChatHeader();
                    this.showNotification('设置已成功保存！', 'success');
                } catch (error) {
                    console.error('保存设置失败:', error);
                    this.showNotification('保存设置失败: ' + error.message, 'error');
                }
            }

            loadSettingsIntoForm() {
                try {
                    const currentApiKey = this.apiKey || '';
                    document.getElementById('settingsApiKey').value = currentApiKey;
                    
                    const tempSlider = document.getElementById('temperatureSlider');
                    const tempValue = document.getElementById('temperatureValue');
                    tempSlider.value = this.settings.temperature;
                    tempValue.textContent = this.settings.temperature;
                    
                    document.getElementById('maxTokensSelect').value = this.settings.max_tokens;
                    
                    document.getElementById('groupChatSequential').checked = this.settings.group_sequential;
                    document.getElementById('groupChatIncludeNames').checked = this.settings.group_include_names;
                    document.getElementById('autoSendAfterVoice').checked = this.settings.auto_send_after_voice;
                    
                } catch (error) {
                    console.error('加载设置失败:', error);
                    this.showNotification('加载设置失败: ' + error.message, 'error');
                }
            }

            toggleApiKeyVisibility() {
                const apiKeyInput = document.getElementById('settingsApiKey');
                const showBtn = document.getElementById('showApiKeyBtn');
                
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    showBtn.innerHTML = '<i class="fa fa-eye-slash"></i>';
                } else {
                    apiKeyInput.type = 'password';
                    showBtn.innerHTML = '<i class="fa fa-eye"></i>';
                }
            }

            updateApiKeyDisplay() {
                if (this.apiKey) {
                    const maskedKey = `API: ${this.apiKey.substring(0, 5)}...${this.apiKey.substring(this.apiKey.length - 5)}`;
                    document.getElementById('apiKeyDisplay').textContent = maskedKey;
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full hover-scale ${
                    type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' :
                    type === 'warning' ? 'bg-yellow-500' :
                    'bg-blue-500'
                }`;
                
                notification.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fa fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
                        ${message}
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            showGroupChatStatus(message) {
                const statusDiv = document.getElementById('groupChatStatus');
                const statusText = document.getElementById('groupChatStatusText');
                statusText.textContent = message;
                statusDiv.classList.remove('hidden');
            }

            hideGroupChatStatus() {
                const statusDiv = document.getElementById('groupChatStatus');
                statusDiv.classList.add('hidden');
            }
        }

        // 全局应用实例
        let app;

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM加载完成，初始化应用...');
            app = new ChatApp();
            console.log('应用初始化完成');
        });

        // 全局函数供HTML调用
        window.app = {
            switchChat: (chatId) => {
                if (app && app.switchChat) {
                    app.switchChat(chatId);
                }
            },
            showGroupSettingsModal: (groupId) => {
                if (app && app.showGroupSettingsModal) {
                    app.showGroupSettingsModal(groupId);
                }
            },
            showDeleteConfirmModal: (type, id, name) => {
                if (app && app.showDeleteConfirmModal) {
                    app.showDeleteConfirmModal(type, id, name);
                }
            },
            toggleMuteMember: (groupId, memberId, mute) => {
                if (app && app.toggleMuteMember) {
                    app.toggleMuteMember(groupId, memberId, mute);
                }
            },
            removeMemberFromGroup: (groupId, memberId) => {
                if (app && app.removeMemberFromGroup) {
                    app.removeMemberFromGroup(groupId, memberId);
                }
            }
        };
    </script>
</body>
</html>